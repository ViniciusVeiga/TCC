@model ETHistoric

@using TCC.Domain.Entities
@using TCC.BusinessLayer.BusinessLayers

@{
    var urlSave = "Learnboard/UserStory/SaveHistoric";
    var page = "Page_1";
}

@Scripts.Render("~/Scripts/Postit")

<script type="text/javascript">
    // Events
    $(document).ready(function () {
        $('#Example').remove();
        $('#Append').append(ePlusPostit)
    });

    $('#Append').on('click', '#Send', function () {
        var input = $('#Text');
        var text = input.val();
        input.val('');

        if (text != '') {
            $('.remove-line').remove();
            $('.p:last').append($('<p></p>').text(text).append(eRemoveLinePostit));

            count();

            if (countLines > 0)
                finishCard();
        }

        input.focus();
    });

    $('#SaveButton').click(function () {
        var result = validationsByJs();

        if (result == true){
            var idProject = $('.postit.active').children('input[name=IdProject]').val();

            var data = {
                'model': {
                    'Id': '@Model.Id',
                    'IdProject': '@Model.IdProject',
                    'CardActors': []
                },
                'page': '@page'
            };

            $('.postit', '#Append').each(function () {
                var cardLine = [];

                $(this).find('p').each(function () {
                    cardLine.push({ 'Line': $(this).text() });
                });

                data.model.CardActors.push({ 'IdHistoric': '@Model.Id', 'CardLines': cardLine });
            });

            $.ajax({
                contentType: 'application/json; charset=utf-8',
                type: 'POST',
                url: '@urlSave',
                data: JSON.stringify(data),
                success: function (data) {
                    changeContent(data);
                }
            });
        }
        else
            $('.board-message')
                .text(result)
                .fadeIn();
    });

    // Functions
    function count() {
        countLines = $('.postit:last p').length;
    }

    function validationsByJs() {
        if ($('.postit', '#Append').length == 0)
            return 'Escreva pelo menos um card';

        return true;
    }

    function finishCard() {
        if (!$('.postit:last').hasClass('alert-dismissible'))
            $('.postit:last').addClass('alert-dismissible').prepend(eRemovePostit);

        $('#Append').append(ePlusPostit);
        $('.postit:last .input-group').remove();
        $('.remove-line').remove();
    }
</script>